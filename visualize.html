<!DOCTYPE html>
<html>
	<head>
		<title>Audio Stream Visualization with Web Audio API</title>
		<script type="text/javascript" src="js/jquery-1.10.2.min.js"></script>
		<link rel="stylesheet" type="text/css" href="css/style.css"/>
		<script type="text/javascript">
		navigator.getUserMedia = navigator.getUserMedia
							|| navigator.webkitGetUserMedia
							|| navigator.mozGetUserMedia
							|| navigator.msGetUserMedia;
		
 		window.AudioContext = window.AudioContext || window.webkitAudioContext;

		window.requestAnimFrame = window.requestAnimationFrame
							|| window.webkitRequestAnimationFrame
							|| window.mozRequestAnimationFrame
							|| window.oRequestAnimationFrame
							|| window.msRequestAnimationFrame;
							
		context = new AudioContext();
		
		function onStream(stream) {
			src = context.createMediaStreamSource(stream);
			analyzer = context.createAnalyser();
			times = new Uint8Array(analyzer.frequencyBinCount);
			freqs = new Uint8Array(analyzer.frequencyBinCount);
			src.connect(analyzer);
			requestAnimFrame(visualize);
		}
		
		function visualize() {
			var canvas = document.querySelector('canvas');
			var drawContext = canvas.getContext('2d');
			drawContext.clearRect(0, 0, 640, 480);
			
			// draw frequency domain
			analyzer.getByteFrequencyData(freqs);
			for (var i = 0; i < freqs.length; i++) {
				var value = freqs[i];
				var percent = value/256;
				var height = canvas.height*percent;
				var offset = canvas.height - height - 1;
				var barWidth = canvas.width/freqs.length;
				drawContext.fillStyle = 'blue';
				drawContext.fillRect(i*barWidth, offset, 1, 1);
			}
			
			// draw time domain
			analyzer.getByteTimeDomainData(times);
			for (var i = 0; i < times.length; i++) {
				var value = times[i];
				var percent = value/256;
				var height = canvas.height*percent;
				var offset = canvas.height - height - 1;
				var barWidth = canvas.width/times.length;
				drawContext.fillStyle = 'black';
				drawContext.fillRect(i*barWidth, offset, 1, 1);
			}
			requestAnimFrame(visualize);
		}
		
		$(function() {
			navigator.getUserMedia({audio: true}, onStream, function(e) {
				alert('Cannot access audio stream.');
				console.log(e);
			});
		});

		</script>
	</head>
	<body>
		<canvas width="640" height="480" class="center"></canvas>
	</body>
</html>
